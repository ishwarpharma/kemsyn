<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üõí Kemsyn Order Form</title>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #ff9a9e, #fad0c4);
    margin: 0;
    padding: 0;
  }
  .screen {
    display: none;
    padding: 20px;
    min-height: 100vh;
  }
  .active {
    display: block;
  }
  h1 {
    text-align: center;
    color: #fff;
    margin-bottom: 20px;
  }
  .input-group {
    margin-bottom: 15px;
    position: relative;
  }
  label {
    font-weight: bold;
    font-size: 1.1em;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 8px;
    border: none;
    font-size: 1em;
  }
  input {
    background: #fff;
  }
  button {
    background: #ff6f91;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background: #ff9671;
  }
  .suggestions {
    background: white;
    border-radius: 8px;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 10;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
  }
  .suggestions div {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
  }
  .suggestions div:hover {
    background: #f1f1f1;
  }
  .cart {
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    padding: 10px;
    margin-top: 15px;
  }
  .cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #ddd;
  }
  .cart-item:last-child {
    border-bottom: none;
  }
  .remove-link {
    color: red;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.2em;
    margin-left: 8px;
  }
  .total {
    font-weight: bold;
    font-size: 1.2em;
    text-align: right;
    margin-top: 10px;
  }
</style>
</head>
<body>

<!-- Screen 1 -->
<div class="screen active" id="screen1">
  <h1>üßæ Order Details</h1>
  <div class="input-group">
    <label>Party Name</label>
    <input type="text" id="partyName" placeholder="Enter party name">
  </div>
  <div class="input-group">
    <label>Salesman Name</label>
    <input type="text" id="salesmanName" placeholder="Enter salesman name">
  </div>
  <div class="input-group">
    <label>Date</label>
    <input type="date" id="orderDate">
  </div>
  <button onclick="goToScreen2()">‚û°Ô∏è Next</button>
</div>

<!-- Screen 2 -->
<div class="screen" id="screen2">
  <h1>üõí Order Items</h1>
  <div class="input-group">
    <label>Search Item</label>
    <input type="text" id="searchBox" placeholder="Search brand...">
    <div id="suggestions" class="suggestions" style="display:none;"></div>
  </div>
  <div class="input-group">
    <label>Selected Item</label>
    <input type="text" id="selectedItem" readonly>
  </div>
  <div class="input-group">
    <label>Qty</label>
    <input type="number" id="itemQty" inputmode="numeric" placeholder="Enter quantity">
  </div>
  <button onclick="addToCart()">‚ûï Add to Cart</button>

  <div class="cart" id="cartContainer">
    <h3>üõç Cart</h3>
    <div id="cartItems"></div>
    <div class="total">Total: ‚Çπ<span id="totalValue">0</span></div>
  </div>

  <button onclick="downloadExcel()">üì• Submit Order</button>
</div>

<script>
let items = [];
let cart = [];
let selectedItemData = null;

// Set today's date
document.getElementById("orderDate").valueAsDate = new Date();

// Fetch Excel file
fetch('kemsyn_google_form.xlsx')
  .then(res => res.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, {type: "array"});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
    items = jsonData.slice(1); // Skip header row
  });

function goToScreen2() {
  const party = document.getElementById("partyName").value.trim();
  const salesman = document.getElementById("salesmanName").value.trim();
  if (!party || !salesman) {
    alert("‚ö†Ô∏è Please fill Party Name and Salesman Name!");
    return;
  }
  document.getElementById("screen1").classList.remove("active");
  document.getElementById("screen2").classList.add("active");
}

document.getElementById("searchBox").addEventListener("input", function() {
  const keyword = this.value.toLowerCase();
  const suggestionsDiv = document.getElementById("suggestions");
  if (keyword.length < 2) {
    suggestionsDiv.style.display = "none";
    return;
  }
  const matches = items.filter(row => (row[1] || "").toLowerCase().includes(keyword));
  suggestionsDiv.innerHTML = "";
  matches.forEach(row => {
    const div = document.createElement("div");
    div.textContent = `${row[1]} (‚Çπ${row[5]})`;
    div.onclick = () => {
      selectedItemData = row;
      document.getElementById("selectedItem").value = row[1];
      suggestionsDiv.style.display = "none";
      document.getElementById("itemQty").focus();
    };
    suggestionsDiv.appendChild(div);
  });
  suggestionsDiv.style.display = matches.length ? "block" : "none";
});

function addToCart() {
  if (!selectedItemData) {
    alert("‚ö†Ô∏è Please select an item!");
    return;
  }
  const qty = parseInt(document.getElementById("itemQty").value) || 0;
  if (qty <= 0) {
    alert("‚ö†Ô∏è Please enter quantity!");
    return;
  }
  const sapCode = selectedItemData[0];
  const brand = selectedItemData[1];
  const price = parseFloat(selectedItemData[5]) || 0;
  const lineTotal = price * qty;

  cart.push({ sapCode, brand, qty, price, lineTotal });
  selectedItemData = null;
  document.getElementById("selectedItem").value = "";
  document.getElementById("itemQty").value = "";
  document.getElementById("searchBox").value = "";
  updateCart();
}

function updateCart() {
  const cartDiv = document.getElementById("cartItems");
  cartDiv.innerHTML = "";
  let totalValue = 0;
  cart.forEach((item, index) => {
    totalValue += item.lineTotal;
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      ${item.brand} - Qty: ${item.qty} - ‚Çπ${item.price} = ‚Çπ${item.lineTotal.toFixed(2)}
      <span class="remove-link" onclick="removeFromCart(${index})">√ó</span>
    `;
    cartDiv.appendChild(div);
  });
  document.getElementById("totalValue").textContent = totalValue.toFixed(2);
}

function removeFromCart(index) {
  cart.splice(index, 1);
  updateCart();
}

function downloadExcel() {
  if (cart.length === 0) {
    alert("‚ö†Ô∏è Cart is empty!");
    return;
  }
  const party = document.getElementById("partyName").value.trim();
  const salesman = document.getElementById("salesmanName").value.trim();
  const date = document.getElementById("orderDate").value;
  let totalValue = cart.reduce((sum, item) => sum + item.lineTotal, 0);

  const wsData = [
    ["Party Name", "Salesman Name", "Date", "SAP Code", "Brand Name", "Qty", "Unit Price", "Line Total"],
    ...cart.map(i => [party, salesman, date, i.sapCode, i.brand, i.qty, i.price, i.lineTotal.toFixed(2)]),
    [],
    ["", "", "", "", "", "", "Total Order Value", totalValue.toFixed(2)]
  ];

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Order");
  XLSX.writeFile(wb, `Order_${party.replace(/\s+/g, '_')}.xlsx`);
}
</script>

</body>
</html>
